# This workflow uses the Revancify script to build everything.
# It does NOT use or need a config.toml file.
# It will build all 16 versions and upload them to a single new release.

name: Build with Revancify

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours

permissions:
  contents: write # To create releases

jobs:
  build:
    runs-on: ubuntu-latest
    
    # This matrix defines all 16 builds you requested
    # (2 apps x 2 architectures x 4 types)
    strategy:
      fail-fast: false # Don't cancel all jobs if one fails
      matrix:
        app: [ 'youtube', 'youtube-music' ]
        arch: [ 'arm64-v8a', 'armeabi-v7a' ]
        type: [ 'non-root', 'root', 'magisk', 'kernelsu' ]

    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends rsync zip unzip
          
      - name: Clone Revancify
        run: |
          git clone https://github.com/decipher3114/Revancify.git
          cd Revancify
          chmod +x revancify
          
      - name: Set Patch Arguments
        # This step sets your custom patches as an environment variable
        run: |
          if [ "${{ matrix.app }}" == "youtube" ]; then
            EXCLUDES="--exclude-patches 'Disable auto captions' --exclude-patches 'Custom branding'"
            ARGS="--patcher-args '-e Custom branding -OcustomName=REVANCED YT'"
          else
            EXCLUDES="--exclude-patches 'Custom branding'"
            ARGS="--patcher-args '-e Custom branding -OcustomName=REVANCED MUSIC'"
          fi
          
          # This is the most important part:
          # If the build is NOT non-root, we must ALSO exclude 'microg-support'
          if [ "${{ matrix.type }}" != "non-root" ]; then
            EXCLUDES="$EXCLUDES --exclude-patches 'microg-support'"
            
            # For Magisk/KSU, add the detach option for Play Store protection
            if [ "${{ matrix.type }}" == "magisk" ] || [ "${{ matrix.type }}" == "kernelsu" ]; then
              EXCLUDES="$EXCLUDES --include-patches 'Play Store detach'"
            fi
          fi
          
          echo "EXCLUDED_PATCHES=$EXCLUDES" >> $GITHUB_ENV
          echo "EXTRA_ARGS=$ARGS" >> $GITHUB_ENV

      - name: Run Revancify
        run: |
          cd Revancify
          
          # This is the main build command
          ./revancify --app-name="${{ matrix.app }}" \
                      --arch="${{ matrix.arch }}" \
                      --type="${{ matrix.type }}" \
                      ${{ env.EXCLUDED_PATCHES }} \
                      ${{ env.EXTRA_ARGS }} \
                      --non-interactive
                      
          # After building, move the file to a common folder for upload
          mkdir -p ../artifacts
          # The output file is in 'build/revancify'
          mv build/revancify/*.apk ../artifacts/ 2>/dev/null || true
          mv build/revancify/*.zip ../artifacts/ 2>/dev/null || true

      - name: Upload Artifacts
        # This uploads the files from this single matrix job
        uses: actions/upload-artifact@v4
        with:
          name: revanced-build-${{ matrix.app }}-${{ matrix.arch }}-${{ matrix.type }}
          path: artifacts/

  # --- Release Job ---
  # This job runs only after ALL 16 builds are finished
  # It gathers all files into one release
  create-release:
    runs-on: ubuntu-latest
    needs: build # Wait for all matrix jobs to finish
    
    steps:
      - name: Generate Tag
        id: tag
        run: echo "TAG_NAME=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts # This will download all artifacts into separate folders
          
      - name: Organize Artifacts
        run: |
          # Move all files from their subfolders into one 'release-files' folder
          mkdir release-files
          find artifacts/ -type f \( -name "*.apk" -o -name "*.zip" \) -exec mv {} release-files/ \;

      - name: Create Release and Upload Assets
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.TAG_NAME }}
          name: ReVanced Build (Revancify) - ${{ env.TAG_NAME }}
          body: "Automated build using decipher3114/Revancify. Contains all types (non-root, root, Magisk, KSU) for armv7 and armv8."
          artifacts: "release-files/*"
          token: ${{ secrets.GITHUB_TOKEN }}
