# This workflow file will run the j-hc builder scripts
# using your *own* config.toml file.
# It includes a new debug step to print the config.

name: Build ReVanced (Hybrid)

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  push:
    paths:
      - 'config.toml' # Also trigger a build if you update your config

permissions:
  contents: write # Needed to create releases

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Generate a Unique Tag for the new release
      - name: Generate Unique Tag
        run: echo "TAG_NAME=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      # 2. Checkout your repository's files (to get your config.toml)
      - name: Checkout Your Config
        uses: actions/checkout@v4

      # 3. Clone the j-hc builder scripts into a temp folder
      - name: Clone ReVanced Builder Scripts
        run: |
          git clone https://github.com/j-hc/revanced-magisk-module builder-scripts
          
      # 4. Inject Your Config
      - name: Inject Your Config
        run: |
          # Copy your config.toml into the builder, replacing its default
          cp ./config.toml ./builder-scripts/config.toml
          
      # 5. --- NEW DEBUG STEP ---
      - name: "Debug: Print config.toml"
        run: |
          echo "--- START OF config.toml ---"
          cat ./builder-scripts/config.toml
          echo "--- END OF config.toml ---"

      # 6. Run the Builder Script
      - name: Run ReVanced Builder
        run: |
          cd builder-scripts
          chmod +x build.sh
          # This script will now read the config we just copied
          ./build.sh
          cd ..
          
      # 7. Create Release and Upload All Built Files
      - name: Create Release and Upload
        uses: ncipollo/release-action@v1
        with:
          # Use the tag we generated
          tag: ${{ env.TAG_NAME }}
          name: ReVanced Build - ${{ env.TAG_NAME }}
          
          # This finds all APKs and ZIPs the script built
          artifacts: "builder-scripts/releases/*"
          
          # This gets the changelog the script generated
          bodyFile: "builder-scripts/releases/CHANGELOG.md"
          
          token: ${{ secrets.GITHUB_TOKEN }}
